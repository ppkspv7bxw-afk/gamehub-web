<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Host</title>

  <style>
    :root{
      --bg0:#07030a;
      --bg1:#14040e;

      --card: rgba(255,255,255,.07);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --red1:#ff1b3a;
      --red2:#ff3d6b;

      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ff2d55;

      --shadow: 0 26px 80px rgba(0,0,0,.62);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
      background:
        radial-gradient(1200px 720px at 18% 10%, rgba(255,27,58,.22), transparent 60%),
        radial-gradient(1000px 720px at 86% 18%, rgba(255,61,107,.16), transparent 58%),
        radial-gradient(900px 620px at 52% 92%, rgba(255,77,77,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px 14px 34px;
    }

    .blob{
      position:fixed;
      width:620px;height:620px;
      border-radius:999px;
      filter: blur(48px);
      opacity:.22;
      z-index:-1;
      animation: float 14s ease-in-out infinite;
      pointer-events:none;
    }
    .blob.a{ left:-240px; top:-220px; background: rgba(255,27,58,.95); }
    .blob.b{ right:-280px; top:40px; background: rgba(255,61,107,.78); animation-duration: 18s; }
    .blob.c{ left:18%; bottom:-320px; background: rgba(255,77,77,.46); animation-duration: 22s; }
    @keyframes float{
      0%,100%{ transform: translate(0,0) scale(1); }
      50%{ transform: translate(28px, -22px) scale(1.06); }
    }

    .wrap{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:stretch;
    }

    .logoTop{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px 0 4px;
    }
    .logoImg{
      width:min(520px, 92vw);
      height:auto;
      display:block;
      filter: drop-shadow(0 16px 36px rgba(0,0,0,.62));
      user-select:none;
      -webkit-user-drag:none;
      transform: translateZ(0);
    }

    .panel{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 320px at 15% 0%, rgba(255,27,58,.18), transparent 60%),
        radial-gradient(700px 320px at 85% 18%, rgba(255,61,107,.12), transparent 60%);
      pointer-events:none;
    }
    .panel > *{ position:relative; }

    .card{
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .muted{ color: var(--muted); font-size: 12px; }

    .lamp{
      width:10px;height:10px;border-radius:50%;
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,45,85,.14);
    }
    .lamp.ok{ background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.14); }
    .lamp.warn{ background: var(--warn); box-shadow: 0 0 0 4px rgba(251,191,36,.14); }
    .lamp.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(255,45,85,.14); }

    .roomBox{
      margin-top:6px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .roomCode{
      direction:ltr;
      font-weight:900;
      letter-spacing: 6px;
      font-size: 34px;
      line-height: 1;
      text-transform: uppercase;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      padding:12px 14px;
      cursor:pointer;
      font-weight:800;
      color:white;
      background: linear-gradient(135deg, rgba(255,27,58,.95), rgba(255,61,107,.65));
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      min-width: 160px;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color: var(--text);
      min-width: 140px;
      padding:10px 12px;
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .spinner{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      border-top-color: rgba(255,255,255,.95);
      animation: spin 1s linear infinite;
      display:none;
    }
    .btn.loading .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .errorBox{
      display:none;
      border:1px solid rgba(255,45,85,.25);
      background: rgba(255,45,85,.10);
      color: rgba(255,220,226,.95);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      line-height:1.5;
    }
    .errorBox.show{ display:block; }

    .toast{
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      color: white;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-size:13px;
      backdrop-filter: blur(10px);
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
  <div class="blob a"></div>
  <div class="blob b"></div>
  <div class="blob c"></div>

  <div class="wrap">
    <div class="logoTop">
      <img class="logoImg" src="/logo.png" alt="Logo">
    </div>

    <section class="panel card">
      <div class="topRow">
        <div class="muted">Host</div>
        <span id="lamp" class="lamp bad" aria-label="connection status"></span>
      </div>

      <div id="err" class="errorBox"></div>

      <div class="roomBox">
        <div>
          <div class="muted">Room Code</div>
          <div id="roomCode" class="roomCode">----</div>
        </div>

        <div class="btnRow">
          <button id="createBtn" class="btn" type="button">
            <span class="spinner"></span>
            <span id="createText">إنشاء روم</span>
          </button>
          <button id="copyCodeBtn" class="btn secondary" type="button">نسخ الكود</button>
          <button id="copyLinkBtn" class="btn secondary" type="button">نسخ رابط</button>
        </div>
      </div>

      <div class="btnRow">
        <button id="backBtn" class="btn secondary" type="button">رجوع</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast">OK</div>

  <script>
    const SERVER_URL = "https://api.gamehub4u.com";
    const WEB_ORIGIN = location.origin;

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = String(msg || "OK");
      t.classList.add("show");
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(() => t.classList.remove("show"), 1600);
    }

    function showError(msg){
      const err = document.getElementById("err");
      if (!msg) { err.classList.remove("show"); err.textContent=""; return; }
      err.textContent = String(msg);
      err.classList.add("show");
    }

    function setLamp(cls){
      const lamp = document.getElementById("lamp");
      lamp.classList.remove("ok","warn","bad");
      lamp.classList.add(cls);
    }

    function loadScriptWithTimeout(src, ms=7000) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        const timer = setTimeout(() => { s.remove(); reject(new Error("timeout")); }, ms);
        s.src = src;
        s.async = true;
        s.onload = () => { clearTimeout(timer); resolve(true); };
        s.onerror = () => { clearTimeout(timer); reject(new Error("load_error")); };
        document.head.appendChild(s);
      });
    }

    function getOrCreateClientId() {
      let id = localStorage.getItem("gh_clientId");
      if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : ("cid_" + Math.random().toString(16).slice(2)));
        localStorage.setItem("gh_clientId", id);
      }
      return id;
    }
    const clientId = getOrCreateClientId();

    function setRoomCode(code){
      const el = document.getElementById("roomCode");
      const v = String(code || "").trim().toUpperCase();
      el.textContent = v || "----";
      if (v) localStorage.setItem("gh_lastRoom", v);
    }
    function getRoomCode(){
      const v = document.getElementById("roomCode").textContent.trim();
      return v === "----" ? "" : v;
    }

    function setLoadingCreate(on){
      const btn = document.getElementById("createBtn");
      const txt = document.getElementById("createText");
      btn.classList.toggle("loading", !!on);
      btn.disabled = !!on;
      txt.textContent = on ? "جاري..." : "إنشاء روم";
    }

    function makeRoomCode(len=4){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // بدون I O 0 1
      let out = "";
      for (let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(String(text||""));
        showToast("تم");
      }catch(_){
        showToast("ما قدرنا");
      }
    }

    let socket = null;

    function emitMany(eventNames, payload){
      if (!socket) return;
      for (const ev of eventNames) socket.emit(ev, payload);
    }

    async function start(){
      setLamp("warn");
      showError("");

      try{
        await loadScriptWithTimeout(SERVER_URL + "/socket.io/socket.io.js", 7000);
      }catch(_){
        setLamp("bad");
        showError("offline");
        return;
      }

      socket = io(SERVER_URL, {
        transports: ["websocket","polling"],
        auth: { clientId }
      });

      socket.on("connect", ()=> setLamp("ok"));
      socket.on("disconnect", ()=> setLamp("bad"));
      socket.on("connect_error", ()=> setLamp("warn"));

      // لو السيرفر يرجع كود بأي اسم معروف نلتقطه
      const acceptRoom = (obj={}) => {
        const code = obj.roomCode || obj.code || obj.room || "";
        if (code) setRoomCode(code);
        setLoadingCreate(false);
      };
      socket.on("host:roomCreated", acceptRoom);
      socket.on("room:created", acceptRoom);
      socket.on("hub:roomCreated", acceptRoom);
      socket.on("create:ok", acceptRoom);
      socket.on("host:ok", acceptRoom);

      socket.on("host:error", ({message}={}) => { setLoadingCreate(false); showError(message || "خطأ"); });
      socket.on("error", () => { setLoadingCreate(false); });

      // Buttons
      document.getElementById("createBtn").onclick = () => {
        showError("");
        setLoadingCreate(true);

        // ✅ نسوي كود فورًا (عشان ما تحس ببطء)
        const code = makeRoomCode(4);
        setRoomCode(code);

        // ✅ نرسل أكثر من event محتمل عشان نضمن السيرفر يلتقط
        const payload = { roomCode: code, clientId };

        emitMany([
          "host:createRoom",
          "host:create",
          "room:create",
          "hub:createRoom",
          "createRoom",
          "create:room",
          "host:claim",
          "host:join",
          "host:openRoom",
          "room:open"
        ], payload);

        // ✅ إذا ما جاء رد من السيرفر خلال 1.5 ثانية، خلاص نوقف اللودنق
        setTimeout(() => setLoadingCreate(false), 1500);
      };

      document.getElementById("copyCodeBtn").onclick = async () => {
        const code = getRoomCode();
        if (!code) return showToast("—");
        await copyText(code);
      };

      document.getElementById("copyLinkBtn").onclick = async () => {
        const code = getRoomCode();
        if (!code) return showToast("—");
        await copyText(WEB_ORIGIN + "/?room=" + encodeURIComponent(code));
      };

      document.getElementById("backBtn").onclick = () => location.href = WEB_ORIGIN + "/";

      // Auto load from URL or last room
      const fromUrl = (new URL(location.href).searchParams.get("room") || "").trim();
      if (fromUrl) setRoomCode(fromUrl);
      else {
        const last = (localStorage.getItem("gh_lastRoom") || "").trim();
        if (last) setRoomCode(last);
      }
    }

    start();
  </script>
</body>
</html>