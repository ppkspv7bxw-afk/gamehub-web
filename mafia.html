<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mafia â€¢ Gamehub4u</title>
  <link rel="stylesheet" href="/common.css"/>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="brand">
          <div class="title">
            <div>Mafia</div>
            <small id="roomLabel">Room: ...</small>
          </div>
        </div>

        <div class="status">
          <span id="light" class="statusLight"></span>
          <span id="statusText">...</span>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="panel">
            <div class="kv"><div class="k">Phase</div><div class="v" id="phase">-</div></div>
            <div class="kv"><div class="k">Round</div><div class="v" id="round">-</div></div>
            <div class="kv"><div class="k">Your Role</div><div class="v" id="role">-</div></div>
            <div class="kv"><div class="k">Status</div><div class="v" id="alive">-</div></div>

            <div class="hr"></div>

            <div id="actionBox">
              <div class="label">Action</div>
              <div class="hint" id="actionHint">-</div>
              <div class="row" style="margin-top:10px">
                <select id="target" class="select" style="flex:1;min-width:220px"></select>
                <button id="doAction" class="btn" type="button">Submit</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button id="nextBtn" class="btn secondary" type="button" style="display:none">Next (Host)</button>
              <button id="lobbyBtn" class="btn ghost" type="button">Back to Lobby</button>
            </div>

            <div class="hint" id="detectiveHint" style="margin-top:10px"></div>
            <div class="hint" id="winnerHint" style="margin-top:10px"></div>
          </div>

          <div class="panel">
            <div class="label">Players</div>
            <ul id="players" class="list"></ul>
            <div class="hint" id="lastResult" style="margin-top:10px; white-space:pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay">
    <div class="box">
      <h3>Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</h3>
      <p>Ø¨Ù†Ø­Ø§ÙˆÙ„ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§â€¦</p>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <script src="https://gamehub-server-okv5.onrender.com/socket.io/socket.io.js"></script>
  <script src="/common.js"></script>
  <script>
    const socket = createSocket();
    bindStatusLight(socket, document.getElementById("light"));
    setupReconnectOverlay(socket);

    const roomLabel = document.getElementById("roomLabel");
    const phaseEl = document.getElementById("phase");
    const roundEl = document.getElementById("round");
    const roleEl = document.getElementById("role");
    const aliveEl = document.getElementById("alive");

    const actionBox = document.getElementById("actionBox");
    const actionHint = document.getElementById("actionHint");
    const targetSel = document.getElementById("target");
    const doActionBtn = document.getElementById("doAction");

    const nextBtn = document.getElementById("nextBtn");
    const lobbyBtn = document.getElementById("lobbyBtn");

    const playersEl = document.getElementById("players");
    const lastResultEl = document.getElementById("lastResult");
    const detectiveHint = document.getElementById("detectiveHint");
    const winnerHint = document.getElementById("winnerHint");

    let roomCode = normalizeRoom(getParam("room") || "");
    let mafiaState = null;

    function setRoomUI(code){
      roomCode = code;
      roomLabel.textContent = "Room: " + code;
      setParam("room", code);
    }

    function renderPlayers(ms){
      playersEl.innerHTML = "";
      targetSel.innerHTML = "";

      const aliveList = ms.alive || [];
      for(const p of aliveList){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="left">
            <span class="pill ${p.alive ? "ok":"bad"}">${p.alive ? "Alive":"Dead"}</span>
            <div style="font-weight:900">${p.name}</div>
          </div>
          <div class="pill">${p.clientId.slice(0,6)}</div>
        `;
        playersEl.appendChild(li);

        if(p.alive){
          const opt = document.createElement("option");
          opt.value = p.clientId;
          opt.textContent = p.name;
          targetSel.appendChild(opt);
        }
      }
    }

    function computeAction(ms){
      if(!ms.started) return { enabled:false, label:"-", act:null };

      const myRole = ms.myRole;
      const me = (ms.alive || []).find(x => x.clientId === clientId);
      const iAmAlive = !!(me && me.alive);

      if(ms.winnerTeam){
        return { enabled:false, label:"Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© âœ…", act:null };
      }

      if(!iAmAlive){
        return { enabled:false, label:"Ø£Ù†Øª Ù…ÙŠØª ðŸ˜… ØªØ§Ø¨Ø¹ ÙÙ‚Ø·", act:null };
      }

      if(ms.phase === "night"){
        if(myRole === "mafia") return { enabled:true, label:"Night: Ø§Ø®ØªØ± Ø´Ø®Øµ ØªÙ‚ØªÙ„Ù‡", act:"kill" };
        if(myRole === "doctor") return { enabled:true, label:"Night: Ø§Ø®ØªØ± Ø´Ø®Øµ ØªÙ†Ù‚Ø°Ù‡", act:"save" };
        if(myRole === "detective") return { enabled:true, label:"Night: Ø§Ø®ØªØ± Ø´Ø®Øµ ØªØªØ­Ù‚Ù‚ Ù…Ù†Ù‡", act:"check" };
        return { enabled:false, label:"Night: Ø£Ù†Øª Villager â€” Ø§Ù†ØªØ¸Ø±", act:null };
      }

      if(ms.phase === "day"){
        return { enabled:true, label:"Day: ØµÙˆÙ‘Øª Ø¹Ù„Ù‰ Ø´Ø®Øµ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ù…", act:"vote" };
      }

      if(ms.phase === "role"){
        return { enabled:false, label:"ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±â€¦ Ø§Ù†ØªØ¸Ø±", act:null };
      }

      return { enabled:false, label:"-", act:null };
    }

    function render(ms){
      mafiaState = ms;
      setRoomUI(ms.roomCode || roomCode);

      phaseEl.textContent = ms.started ? ms.phase : "not started";
      roundEl.textContent = ms.started ? String(ms.round) : "-";
      roleEl.textContent = ms.myRole || "-";

      const me = (ms.alive || []).find(x => x.clientId === clientId);
      aliveEl.textContent = me ? (me.alive ? "Alive" : "Dead") : "-";

      renderPlayers(ms);

      const a = computeAction(ms);
      actionHint.textContent = a.label;
      actionBox.style.opacity = a.enabled ? "1" : ".65";
      doActionBtn.disabled = !a.enabled;

      nextBtn.style.display = ms.canAdvance ? "inline-block" : "none";

      if(ms.investigationResult){
        detectiveHint.textContent = "ØªØ­Ù‚ÙŠÙ‚: " + (ms.investigationResult.isMafia ? "MAFIA âœ…" : "NOT mafia âŒ");
      }else{
        detectiveHint.textContent = "";
      }

      if(ms.winnerTeam){
        winnerHint.textContent = "Winner: " + ms.winnerTeam;
      }else{
        winnerHint.textContent = "";
      }

      lastResultEl.textContent = ms.lastResult ? ("Last Result:\n" + JSON.stringify(ms.lastResult, null, 2)) : "";
    }

    socket.on("connect", () => {
      if(!roomCode) return showToast("No room in URL");
      setRoomUI(roomCode);

      socket.emit("player:attach", { roomCode, clientId });
      socket.emit("mafia:getState", { roomCode, clientId });
    });

    socket.on("mafia:state", (ms) => render(ms));
    socket.on("mafia:role", ({ role } = {}) => {
      if(role) roleEl.textContent = role;
    });

    doActionBtn.onclick = () => {
      if(!mafiaState) return;
      const a = computeAction(mafiaState);
      const targetId = targetSel.value;
      if(!a.enabled || !targetId) return showToast("Ø§Ø®ØªØ± Target");

      if(a.act === "vote"){
        socket.emit("mafia:vote", { roomCode, clientId, targetId });
        return showToast("Voted âœ…");
      }

      socket.emit("mafia:nightAction", { roomCode, clientId, action: a.act, targetId });
      showToast("Done âœ…");
    };

    nextBtn.onclick = () => {
      if(!roomCode) return;
      socket.emit("mafia:next", { roomCode });
    };

    lobbyBtn.onclick = () => location.href = WEB_ORIGIN + "/lobby.html?room=" + encodeURIComponent(roomCode);
  </script>
</body>
</html>
